@{
    ViewData["Title"] = "iPhone-style Calculator AJAX & Fetch";
}

<style>
    body {
        font-family: 'Segoe UI', sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        background: linear-gradient(135deg, #ff9a9e, #fad0c4, #a18cd1, #fbc2eb);
        padding: 20px;
        min-height: 100vh;
        transition: background 0.5s;
    }

    .calculator {
        background: #000;
        padding: 20px;
        border-radius: 30px;
        width: 320px;
        margin-bottom: 40px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .display {
        background: #1c1c1c;
        color: white;
        font-size: 2em;
        text-align: right;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 10px;
        min-height: 60px;
        word-wrap: break-word;
    }

    .buttons {
        display: grid;
        grid-template-columns: repeat(4, 70px);
        grid-auto-rows: 70px;
        gap: 10px;
    }

    .btn {
        width: 70px;
        height: 70px;
        font-size: 1.5em;
        border: none;
        border-radius: 50%;
        background: #333;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.1s;
    }

        .btn.operator {
            background: orange;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn.double {
            grid-column: span 2;
            border-radius: 35px;
            width: calc(70px * 2 + 10px);
        }

        .btn.equal {
            grid-column: span 3;
            border-radius: 35px;
            width: calc(70px * 3 + 20px);
            background-color: orange;
        }

        .btn.advance {
            background: #5dade2; /* ฟ้าอมม่วง */
            color: white; /* ตัวหนังสือตัดชัด */
            font-weight: bold;
            border: 2px solid #fff; /* optional เพิ่มขอบขาวบางๆ ให้เด่น */
            box-shadow: 0 4px 8px rgba(93, 173, 226, 0.5);
            transition: 0.2s;
        }

        .btn.advance:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(93, 173, 226, 0.5);
        }
    .calculator-title {
        color: #000;
        margin-bottom: 5px;
        font-weight: bold;
        text-align: center;
    }

    .mode-toggle {
        background: #444;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 5px 15px;
        margin: 10px auto;
        display: block;
        cursor: pointer;
        font-weight: bold;
    }
</style>

<!-- AJAX Calculator -->
<h1>AJAX Calculator</h1>
<div class="calculator">
    <div class="calculator-title">AJAX Calculator</div>
    <button id="ajaxModeBtn" class="mode-toggle">Mode: DEG</button>
    <div id="ajaxDisplay" class="display">0</div>
    <div class="buttons">
        <button class="btn operator" onclick="ajaxClear()">C</button>
        <button class="btn operator" onclick="ajaxBack()">⌫</button>
        <button class="btn operator" onclick="ajaxAppend('%')">%</button>
        <button class="btn operator" onclick="ajaxAppend('^')">^</button>

        <button class="btn" onclick="ajaxAppend('7')">7</button>
        <button class="btn" onclick="ajaxAppend('8')">8</button>
        <button class="btn" onclick="ajaxAppend('9')">9</button>
        <button class="btn operator" onclick="ajaxAppend('/')">÷</button>

        <button class="btn" onclick="ajaxAppend('4')">4</button>
        <button class="btn" onclick="ajaxAppend('5')">5</button>
        <button class="btn" onclick="ajaxAppend('6')">6</button>
        <button class="btn operator" onclick="ajaxAppend('*')">×</button>

        <button class="btn" onclick="ajaxAppend('1')">1</button>
        <button class="btn" onclick="ajaxAppend('2')">2</button>
        <button class="btn" onclick="ajaxAppend('3')">3</button>
        <button class="btn operator" onclick="ajaxAppend('-')">−</button>

        <button class="btn double" onclick="ajaxAppend('0')">0</button>
        <button class="btn" onclick="ajaxAppend('.')">.</button>
        <button class="btn operator" onclick="ajaxAppend('+')">+</button>
        <button class="btn equal" onclick="ajaxEvaluate()">=</button>
        <button id="ajaxAdvanceBtn" class="btn advance">sin(</button>
    </div>
</div>

<!-- Fetch Calculator -->
<h1>Fetch Calculator</h1>
<div class="calculator">
    <div class="calculator-title">Fetch Calculator</div>
    <button id="fetchModeBtn" class="mode-toggle">Mode: DEG</button>
    <div id="fetchDisplay" class="display">0</div>
    <div class="buttons">
        <button class="btn operator" onclick="fetchClear()">C</button>
        <button class="btn operator" onclick="fetchBack()">⌫</button>
        <button class="btn operator" onclick="fetchAppend('%')">%</button>
        <button class="btn operator" onclick="fetchAppend('^')">^</button>

        <button class="btn" onclick="fetchAppend('7')">7</button>
        <button class="btn" onclick="fetchAppend('8')">8</button>
        <button class="btn" onclick="fetchAppend('9')">9</button>
        <button class="btn operator" onclick="fetchAppend('/')">÷</button>

        <button class="btn" onclick="fetchAppend('4')">4</button>
        <button class="btn" onclick="fetchAppend('5')">5</button>
        <button class="btn" onclick="fetchAppend('6')">6</button>
        <button class="btn operator" onclick="fetchAppend('*')">×</button>

        <button class="btn" onclick="fetchAppend('1')">1</button>
        <button class="btn" onclick="fetchAppend('2')">2</button>
        <button class="btn" onclick="fetchAppend('3')">3</button>
        <button class="btn operator" onclick="fetchAppend('-')">−</button>

        <button class="btn double" onclick="fetchAppend('0')">0</button>
        <button class="btn" onclick="fetchAppend('.')">.</button>
        <button class="btn operator" onclick="fetchAppend('+')">+</button>
        <button class="btn equal" onclick="fetchEvaluate()">=</button>
        <button id="fetchAdvanceBtn" class="btn advance">sin(</button>
    </div>
</div>

<script>
    /* ===== Global Mode State ===== */
    let ajaxMode = "deg";
    let fetchMode = "deg";

    const ajaxModeBtn = document.getElementById('ajaxModeBtn');
    const fetchModeBtn = document.getElementById('fetchModeBtn');

    ajaxModeBtn.addEventListener('click', () => {
        ajaxMode = ajaxMode === "deg" ? "rad" : "deg";
        ajaxModeBtn.innerText = "Mode: " + ajaxMode.toUpperCase();
    });

    fetchModeBtn.addEventListener('click', () => {
        fetchMode = fetchMode === "deg" ? "rad" : "deg";
        fetchModeBtn.innerText = "Mode: " + fetchMode.toUpperCase();
    });

    /* ===== AJAX ===== */
    let ajaxCurrent = '';
    function ajaxAppend(char) { ajaxCurrent += char; updateAjaxDisplay(); }
    function ajaxClear() { ajaxCurrent = ''; updateAjaxDisplay(); }
    function ajaxBack() { ajaxCurrent = ajaxCurrent.slice(0,-1); updateAjaxDisplay(); }
    function updateAjaxDisplay() { document.getElementById('ajaxDisplay').innerText = ajaxCurrent || '0'; }
    function ajaxEvaluate() {
        if(!ajaxCurrent) return;
        let xhr = new XMLHttpRequest();
        xhr.open("POST", "/Calculator/EvaluateAjax", true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function(){
            if(xhr.readyState===4 && xhr.status===200){
                let data = JSON.parse(xhr.responseText);
                ajaxCurrent = data.result;
                updateAjaxDisplay();
            }
        };
        xhr.send("expression=" + encodeURIComponent(ajaxCurrent) + "&mode=" + ajaxMode);
    }

    /* ===== Fetch ===== */
    let fetchCurrent = '';
    function fetchAppend(char){ fetchCurrent+=char; updateFetchDisplay(); }
    function fetchClear(){ fetchCurrent=''; updateFetchDisplay(); }
    function fetchBack(){ fetchCurrent=fetchCurrent.slice(0,-1); updateFetchDisplay(); }
    function updateFetchDisplay(){ document.getElementById('fetchDisplay').innerText = fetchCurrent || '0'; }
    async function fetchEvaluate(){
        if(!fetchCurrent) return;
        let formData = new FormData();
        formData.append("expression", fetchCurrent);
        formData.append("mode", fetchMode);
        let response = await fetch("/Calculator/EvaluateFetch",{method:"POST",body:formData});
        let data = await response.json();
        fetchCurrent=data.result;
        updateFetchDisplay();
    }

    /* ===== Advanced Functions ===== */
    const advancedFuncs = ['sin','cos','tan','log','√','('];

    let ajaxAdvanceIndex = 0;
    let fetchAdvanceIndex = 0;
    let ajaxOpenParen = false;
    let fetchOpenParen = false;

    const ajaxAdvanceBtn = document.getElementById('ajaxAdvanceBtn');
    const fetchAdvanceBtn = document.getElementById('fetchAdvanceBtn');

    function updateAjaxButtonText(){
        let func = advancedFuncs[ajaxAdvanceIndex];
        if(ajaxOpenParen) ajaxAdvanceBtn.innerText = ')';
        else ajaxAdvanceBtn.innerText = func + (func==='('?'':'(');
    }

    function updateFetchButtonText(){
        let func = advancedFuncs[fetchAdvanceIndex];
        if(fetchOpenParen) fetchAdvanceBtn.innerText = ')';
        else fetchAdvanceBtn.innerText = func + (func==='('?'':'(');
    }

    function ajaxAdvanceClick(){
        let func = advancedFuncs[ajaxAdvanceIndex];
        if(!ajaxOpenParen){
            ajaxAppend(func==='('? '(' : func+'(');
            ajaxOpenParen = true;
            ajaxAdvanceBtn.innerText = ')';
        } else {
            ajaxAppend(')');
            ajaxOpenParen = false;
            updateAjaxButtonText();
        }
    }

    function fetchAdvanceClick(){
        let func = advancedFuncs[fetchAdvanceIndex];
        if(!fetchOpenParen){
            fetchAppend(func==='('? '(' : func+'(');
            fetchOpenParen = true;
            fetchAdvanceBtn.innerText = ')';
        } else {
            fetchAppend(')');
            fetchOpenParen = false;
            updateFetchButtonText();
        }
    }

    ajaxAdvanceBtn.addEventListener('click', ajaxAdvanceClick);
    fetchAdvanceBtn.addEventListener('click', fetchAdvanceClick);

    /* ===== Key Handling ===== */
    document.addEventListener('keydown', function(e){
        if(e.key==='Tab'){
            e.preventDefault();
            ajaxAdvanceIndex = (ajaxAdvanceIndex + 1) % advancedFuncs.length;
            ajaxOpenParen=false;
            updateAjaxButtonText();
            ajaxAdvanceBtn.focus();
        }
        if(e.ctrlKey){
            e.preventDefault();
            fetchAdvanceIndex = (fetchAdvanceIndex + 1) % advancedFuncs.length;
            fetchOpenParen=false;
            updateFetchButtonText();
            fetchAdvanceBtn.focus();
        }
    });

    updateAjaxButtonText();
    updateFetchButtonText();
</script>
